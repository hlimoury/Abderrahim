<!-- views/categoryDetails.ejs (CREATE THIS NEW FILE) -->
<nav class="p-3">
    <a href="/stats" class="btn btn-primary">Stats Accueil</a>
    <a href="/admin/archived" class="btn btn-secondary">Rapports Archivés</a>
    <a href="/adminlogout" class="btn btn-danger">Se Déconnecter</a>
  </nav>
  
  <div class="container-fluid mt-3">
    <h2 class="mb-3"><%= categoryLabel %> - Détails</h2>
  
    <!-- Advanced search/filter -->
    <div class="card mb-3">
      <div class="card-header">Recherche Avancée</div>
      <div class="card-body">
        <form action="/stats/category/<%= category %>" method="GET" class="row g-3">
          <div class="col-md-3">
            <input class="form-control" type="text" name="nom" placeholder="Nom du magasin" value="<%= searchParams.nom || '' %>">
          </div>
          <div class="col-md-3">
            <select class="form-select" name="ville">
              <option value="">Toutes les régions</option>
              <% (availableRegions||[]).forEach(r=>{ %>
                <option value="<%= r %>" <%= searchParams.ville===r ? 'selected':'' %>><%= r %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" name="mois">
              <option value="">Tous les mois</option>
              <% for(let i=1;i<=12;i++){ %>
                <option value="<%= i %>" <%= (searchParams.mois===i)?'selected':'' %>>
                  <%= new Date(0, i-1).toLocaleString('fr-FR',{month:'long'}) %>
                </option>
              <% } %>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" name="annee">
              <option value="">Toutes les années</option>
              <% const currentYear = new Date().getFullYear();
                 for(let y=currentYear; y>=currentYear-5; y--) { %>
                <option value="<%= y %>" <%= (searchParams.annee===y)?'selected':'' %>><%= y %></option>
              <% } %>
            </select>
          </div>
          <div class="col-md-1 d-grid">
            <button class="btn btn-primary" type="submit">Filtrer</button>
          </div>
          <div class="col-md-1 d-grid">
            <a class="btn btn-outline-secondary" href="/stats/category/<%= category %>">Réinitialiser</a>
          </div>
        </form>
      </div>
    </div>
  
    <!-- Totals header -->
    <div class="row g-3 mb-3">
      <% if (category === 'formation') { %>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header bg-primary text-white">Total sélection (cette page)</div>
            <div class="card-body">
              <h2 id="f-total"><%= pageTotals.formationTotal %> P</h2>
              <div class="mt-2">
                <span class="badge bg-success me-2">Incendie: <span id="f-incendie"><%= pageTotals.formationByType['Incendie'] %></span></span>
                <span class="badge bg-info me-2">SST: <span id="f-sst"><%= pageTotals.formationByType['SST'] %></span></span>
                <span class="badge bg-secondary">Intégration: <span id="f-integration"><%= pageTotals.formationByType['Intégration'] %></span></span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">Total filtré (toutes pages)</div>
            <div class="card-body">
              <h3><%= totalsAll.formationTotal %> P</h3>
              <div class="text-muted small">
                Incendie <%= totalsAll.formationByType['Incendie'] %> •
                SST <%= totalsAll.formationByType['SST'] %> •
                Intégration <%= totalsAll.formationByType['Intégration'] %>
              </div>
            </div>
          </div>
        </div>
      <% } else if (category === 'accidents') { %>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header bg-danger text-white">Total sélection (cette page)</div>
            <div class="card-body">
              <h2><span id="a-count"><%= pageTotals.accidentsCount %></span></h2>
              <div class="text-muted">Jours d'arrêt: <strong id="a-jours"><%= pageTotals.accidentsJours %></strong></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">Total filtré (toutes pages)</div>
            <div class="card-body">
              <h3><%= totalsAll.accidentsCount %></h3>
              <div class="text-muted">Jours d'arrêt: <%= totalsAll.accidentsJours %></div>
            </div>
          </div>
        </div>
      <% } else if (category === 'incidents') { %>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header bg-warning text-dark">Total sélection (cette page)</div>
            <div class="card-body">
              <h2 id="i-total"><%= pageTotals.incidentsTotal %></h2>
              <div class="small mt-2">
                <% Object.entries(pageTotals.incidentByType).forEach(([k,v])=>{ %>
                  <span class="badge bg-light text-dark border me-1">
                    <%= k %>: <span id="i-<%= k.replace(/\s+/g,'_') %>"><%= v %></span>
                  </span>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">Total filtré (toutes pages)</div>
            <div class="card-body">
              <h3><%= totalsAll.incidentsTotal %></h3>
              <div class="small text-muted">
                <% Object.entries(totalsAll.incidentByType).forEach(([k,v])=>{ %>
                  <span class="badge bg-light text-dark border me-1"><%= k %>: <%= v %></span>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
      <% } else if (category === 'interpellations') { %>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header bg-success text-white">Total sélection (cette page)</div>
            <div class="card-body">
              <h2><span id="it-personnes"><%= pageTotals.interPersonnes %></span> P</h2>
              <div class="text-muted mb-2">
                <span id="it-poursuites"><%= pageTotals.interPoursuites %></span> PJ •
                <span id="it-valeur"><%= pageTotals.interValeur.toFixed(3).replace('.',',') %></span> kDH
              </div>
              <div class="small mt-2">
                <% ['Client','Personnel','Prestataire'].forEach(t=>{ %>
                  <span class="badge bg-light text-dark border me-1">
                    <%= t %>:
                    <span id="it-<%= t %>-p"><%= pageTotals.interByType[t].personnes %></span>P /
                    <span id="it-<%= t %>-pj"><%= pageTotals.interByType[t].poursuites %></span>PJ /
                    <span id="it-<%= t %>-v"><%= pageTotals.interByType[t].valeur.toFixed(3).replace('.',',') %></span>kDH
                  </span>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">Total filtré (toutes pages)</div>
            <div class="card-body">
              <h3><%= totalsAll.interPersonnes %> P</h3>
              <div class="text-muted mb-1">
                <%= totalsAll.interPoursuites %> PJ • <%= totalsAll.interValeur.toFixed(3).replace('.',',') %> kDH
              </div>
              <div class="small text-muted">
                <% ['Client','Personnel','Prestataire'].forEach(t=>{ %>
                  <span class="badge bg-light text-dark border me-1">
                    <%= t %>:
                    <%= totalsAll.interByType[t].personnes %>P /
                    <%= totalsAll.interByType[t].poursuites %>PJ /
                    <%= totalsAll.interByType[t].valeur.toFixed(3).replace('.',',') %>kDH
                  </span>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  
    <!-- Actions for checkboxes -->
    <div class="d-flex gap-2 mb-2">
      <button id="select-all" class="btn btn-sm btn-outline-primary">Tout cocher</button>
      <button id="unselect-all" class="btn btn-sm btn-outline-secondary">Tout décocher</button>
    </div>
  
    <!-- Markets table -->
    <div class="card">
      <div class="card-header">Magasins (10 par page)</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Inclure</th>
                <th>Magasin</th>
                <th>Ville</th>
                <% if (category === 'formation') { %>
                  <th>Formation (P)</th>
                  <th>Incendie</th>
                  <th>SST</th>
                  <th>Intégration</th>
                <% } else if (category === 'accidents') { %>
                  <th>Accidents</th>
                  <th>Jours d'arrêt</th>
                <% } else if (category === 'incidents') { %>
                  <th>Incidents</th>
                  <th>Départ de feu</th>
                  <th>Agression</th>
                  <th>Autorités</th>
                  <th>Sinistre client</th>
                  <th>Acte sécurisation</th>
                  <th>Autre</th>
                <% } else if (category === 'interpellations') { %>
                  <th>Personnes</th>
                  <th>PJ</th>
                  <th>Valeur (kDH)</th>
                  <th>Client (P/PJ/kDH)</th>
                  <th>Personnel (P/PJ/kDH)</th>
                  <th>Prestataire (P/PJ/kDH)</th>
                <% } %>
              </tr>
            </thead>
            <tbody id="markets-tbody">
              <% rows.forEach(r=>{ %>
                <tr
                  <% if (category === 'formation') { %>
                    data-f-total="<%= r.fTotal %>"
                    data-f-incendie="<%= r.fTypes['Incendie'] %>"
                    data-f-sst="<%= r.fTypes['SST'] %>"
                    data-f-integration="<%= r.fTypes['Intégration'] %>"
                  <% } else if (category === 'accidents') { %>
                    data-a-count="<%= r.aCount %>"
                    data-a-jours="<%= r.aJours %>"
                  <% } else if (category === 'incidents') { %>
                    data-i-total="<%= r.iTotal %>"
                    data-i-depart_de_feu="<%= r.iTypes['Départ de feu'] %>"
                    data-i-agression="<%= r.iTypes['Agression envers le personnel'] %>"
                    data-i-autorites="<%= r.iTypes['Passage des autorités'] %>"
                    data-i-sinistre_client="<%= r.iTypes['Sinistre déclaré par un client'] %>"
                    data-i-acte_securisation="<%= r.iTypes['Acte de sécurisation'] %>"
                    data-i-autre="<%= r.iTypes['Autre'] %>"
                  <% } else if (category === 'interpellations') { %>
                    data-it-personnes="<%= r.itPersonnes %>"
                    data-it-poursuites="<%= r.itPoursuites %>"
                    data-it-valeur="<%= r.itValeur %>"
                    data-it-client-p="<%= r.itTypes.Client.personnes %>"
                    data-it-client-pj="<%= r.itTypes.Client.poursuites %>"
                    data-it-client-v="<%= r.itTypes.Client.valeur %>"
                    data-it-personnel-p="<%= r.itTypes.Personnel.personnes %>"
                    data-it-personnel-pj="<%= r.itTypes.Personnel.poursuites %>"
                    data-it-personnel-v="<%= r.itTypes.Personnel.valeur %>"
                    data-it-prestataire-p="<%= r.itTypes.Prestataire.personnes %>"
                    data-it-prestataire-pj="<%= r.itTypes.Prestataire.poursuites %>"
                    data-it-prestataire-v="<%= r.itTypes.Prestataire.valeur %>"
                  <% } %>
                >
                  <td>
                    <input type="checkbox" class="form-check-input market-select" checked>
                  </td>
                  <td><%= r.nom %></td>
                  <td><%= r.ville %></td>
  
                  <% if (category === 'formation') { %>
                    <td><%= r.fTotal %></td>
                    <td><%= r.fTypes['Incendie'] %></td>
                    <td><%= r.fTypes['SST'] %></td>
                    <td><%= r.fTypes['Intégration'] %></td>
                  <% } else if (category === 'accidents') { %>
                    <td><%= r.aCount %></td>
                    <td><%= r.aJours %></td>
                  <% } else if (category === 'incidents') { %>
                    <td><%= r.iTotal %></td>
                    <td><%= r.iTypes['Départ de feu'] %></td>
                    <td><%= r.iTypes['Agression envers le personnel'] %></td>
                    <td><%= r.iTypes['Passage des autorités'] %></td>
                    <td><%= r.iTypes['Sinistre déclaré par un client'] %></td>
                    <td><%= r.iTypes['Acte de sécurisation'] %></td>
                    <td><%= r.iTypes['Autre'] %></td>
                  <% } else if (category === 'interpellations') { %>
                    <td><%= r.itPersonnes %></td>
                    <td><%= r.itPoursuites %></td>
                    <td><%= r.itValeur.toFixed(3).replace('.',',') %></td>
                    <td>
                      <%= r.itTypes.Client.personnes %> / <%= r.itTypes.Client.poursuites %> /
                      <%= r.itTypes.Client.valeur.toFixed(3).replace('.',',') %>
                    </td>
                    <td>
                      <%= r.itTypes.Personnel.personnes %> / <%= r.itTypes.Personnel.poursuites %> /
                      <%= r.itTypes.Personnel.valeur.toFixed(3).replace('.',',') %>
                    </td>
                    <td>
                      <%= r.itTypes.Prestataire.personnes %> / <%= r.itTypes.Prestataire.poursuites %> /
                      <%= r.itTypes.Prestataire.valeur.toFixed(3).replace('.',',') %>
                    </td>
                  <% } %>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
  
        <!-- Pagination -->
        <nav>
          <ul class="pagination">
            <li class="page-item <%= currentPage<=1?'disabled':'' %>">
              <a class="page-link" href="/stats/category/<%= category %>?nom=<%= encodeURIComponent(searchParams.nom||'') %>&ville=<%= encodeURIComponent(searchParams.ville||'') %>&mois=<%= searchParams.mois||'' %>&annee=<%= searchParams.annee||'' %>&page=<%= currentPage-1 %>">Précédent</a>
            </li>
            <% for(let p=1;p<=totalPages;p++){ %>
              <li class="page-item <%= currentPage===p?'active':'' %>">
                <a class="page-link" href="/stats/category/<%= category %>?nom=<%= encodeURIComponent(searchParams.nom||'') %>&ville=<%= encodeURIComponent(searchParams.ville||'') %>&mois=<%= searchParams.mois||'' %>&annee=<%= searchParams.annee||'' %>&page=<%= p %>"><%= p %></a>
              </li>
            <% } %>
            <li class="page-item <%= currentPage>=totalPages?'disabled':'' %>">
              <a class="page-link" href="/stats/category/<%= category %>?nom=<%= encodeURIComponent(searchParams.nom||'') %>&ville=<%= encodeURIComponent(searchParams.ville||'') %>&mois=<%= searchParams.mois||'' %>&annee=<%= searchParams.annee||'' %>&page=<%= currentPage+1 %>">Suivant</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
  (function(){
    const category = '<%= category %>';
    const fmtKD = (v)=> (Number(v)||0).toFixed(3).replace('.',',');
  
    function compute() {
      const rows = Array.from(document.querySelectorAll('#markets-tbody tr'));
      const checked = rows.filter(r => r.querySelector('.market-select').checked);
  
      if (category === 'formation') {
        let total=0, inc=0, sst=0, integ=0;
        checked.forEach(r=>{
          total += Number(r.dataset.fTotal||0);
          inc   += Number(r.dataset.fIncendie||0);
          sst   += Number(r.dataset.fSst||0);
          integ += Number(r.dataset.fIntegration||0);
        });
        document.getElementById('f-total').textContent = total + ' P';
        document.getElementById('f-incendie').textContent = inc;
        document.getElementById('f-sst').textContent = sst;
        document.getElementById('f-integration').textContent = integ;
      }
  
      if (category === 'accidents') {
        let c=0, j=0;
        checked.forEach(r=>{
          c += Number(r.dataset.aCount||0);
          j += Number(r.dataset.aJours||0);
        });
        document.getElementById('a-count').textContent = c;
        document.getElementById('a-jours').textContent = j;
      }
  
      if (category === 'incidents') {
        let total=0;
        let types = {
          'Départ_de_feu':0, 'Agression_envers_le_personnel':0,
          'Passage_des_autorités':0, 'Sinistre_déclaré_par_un_client':0,
          'Acte_de_sécurisation':0, 'Autre':0
        };
        checked.forEach(r=>{
          total += Number(r.dataset.iTotal||0);
          types['Départ_de_feu'] += Number(r.dataset.iDepart_de_feu||0);
          types['Agression_envers_le_personnel'] += Number(r.dataset.iAgression||0);
          types['Passage_des_autorités'] += Number(r.dataset.iAutorites||0);
          types['Sinistre_déclaré_par_un_client'] += Number(r.dataset.iSinistre_client||0);
          types['Acte_de_sécurisation'] += Number(r.dataset.iActe_securisation||0);
          types['Autre'] += Number(r.dataset.iAutre||0);
        });
        document.getElementById('i-total').textContent = total;
        // update badges if exist
        function set(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }
        set('i-Départ_de_feu', types['Départ_de_feu']);
        set('i-Agression_envers_le_personnel', types['Agression_envers_le_personnel']);
        set('i-Passage_des_autorités', types['Passage_des_autorités']);
        set('i-Sinistre_déclaré_par_un_client', types['Sinistre_déclaré_par_un_client']);
        set('i-Acte_de_sécurisation', types['Acte_de_sécurisation']);
        set('i-Autre', types['Autre']);
      }
  
      if (category === 'interpellations') {
        let p=0, pj=0, v=0;
        let byType = {
          Client:{p:0,pj:0,v:0},
          Personnel:{p:0,pj:0,v:0},
          Prestataire:{p:0,pj:0,v:0}
        };
        checked.forEach(r=>{
          p  += Number(r.dataset.itPersonnes||0);
          pj += Number(r.dataset.itPoursuites||0);
          v  += Number(r.dataset.itValeur||0);
          byType.Client.p       += Number(r.dataset.itClientP||0);
          byType.Client.pj      += Number(r.dataset.itClientPj||0);
          byType.Client.v       += Number(r.dataset.itClientV||0);
          byType.Personnel.p    += Number(r.dataset.itPersonnelP||0);
          byType.Personnel.pj   += Number(r.dataset.itPersonnelPj||0);
          byType.Personnel.v    += Number(r.dataset.itPersonnelV||0);
          byType.Prestataire.p  += Number(r.dataset.itPrestataireP||0);
          byType.Prestataire.pj += Number(r.dataset.itPrestatairePj||0);
          byType.Prestataire.v  += Number(r.dataset.itPrestataireV||0);
        });
        document.getElementById('it-personnes').textContent = p;
        document.getElementById('it-poursuites').textContent = pj;
        document.getElementById('it-valeur').textContent = fmtKD(v);
        function set(prefix, obj){
          const pEl = document.getElementById(prefix+'-p');
          const pjEl= document.getElementById(prefix+'-pj');
          const vEl = document.getElementById(prefix+'-v');
          if(pEl) pEl.textContent = obj.p;
          if(pjEl) pjEl.textContent = obj.pj;
          if(vEl) vEl.textContent = fmtKD(obj.v);
        }
        set('it-Client', byType.Client);
        set('it-Personnel', byType.Personnel);
        set('it-Prestataire', byType.Prestataire);
      }
    }
  
    document.querySelectorAll('.market-select').forEach(cb=>{
      cb.addEventListener('change', compute);
    });
  
    document.getElementById('select-all').addEventListener('click', function(e){
      e.preventDefault();
      document.querySelectorAll('.market-select').forEach(cb=> cb.checked = true);
      compute();
    });
  
    document.getElementById('unselect-all').addEventListener('click', function(e){
      e.preventDefault();
      document.querySelectorAll('.market-select').forEach(cb=> cb.checked = false);
      compute();
    });
  
    // Initial compute
    compute();
  })();
  </script>